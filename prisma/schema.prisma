generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  SUPERADMIN
  OWNER
  MANAGER
  CASHIER
}

enum MovementType {
  ENTRY
  TRANSFER
  SALE
  WASTE
}

model Business {
  id          String  @id @default(uuid())
  name        String
  description String?
  logo        String?
  isActive    Boolean @default(true)

  users        User[]
  userAccess   UserBusinessAccess[]
  warehouses   Warehouse[]
  pointsOfSale PointOfSale[]
  products     Product[]
  currencies   Currency[]
  customers    Customer[]
  expenses     Expense[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model UserBusinessAccess {
  id         String   @id @default(uuid())
  userId     String
  businessId String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([userId, businessId])
}

model Currency {
  id         String         @id @default(uuid())
  businessId String
  code       String // e.g., "USD", "CUP"
  name       String
  symbol     String?
  isBase     Boolean        @default(false)
  business   Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  rates      CurrencyRate[]
  debts      Debt[]
  payments   DebtPayment[]
  expenses   Expense[]
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@unique([businessId, code])
}

model User {
  id             String               @id @default(uuid())
  businessId     String
  email          String               @unique
  password       String
  role           Role                 @default(CASHIER)
  name           String
  phoneNumber    String?
  address        String?
  identityNumber String?              @unique
  posId          String?
  business       Business             @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessAccess UserBusinessAccess[]
  pointOfSale    PointOfSale?         @relation(fields: [posId], references: [id])
  deletedAt      DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
}

model Product {
  id              String           @id @default(uuid())
  businessId      String
  name            String
  description     String?
  category        String?
  unit            String           @default("unit")
  costPrice       Float            @default(0) // Average Cost (WAC)
  sellingPriceCUP Float            @default(0)
  business        Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  warehouseStock  WarehouseStock[]
  posStock        POSStock[]
  movements       StockMovement[]
  saleItems       SaleItem[]
  deletedAt       DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model Warehouse {
  id         String           @id @default(uuid())
  businessId String
  name       String
  location   String?
  business   Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  stocks     WarehouseStock[]
  deletedAt  DateTime?
  createdAt  DateTime         @default(now())
}

model PointOfSale {
  id          String     @id @default(uuid())
  businessId  String
  name        String
  location    String?
  description String?
  business    Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  stocks      POSStock[]
  sales       Sale[]
  users       User[]
  deletedAt   DateTime?
  createdAt   DateTime   @default(now())
}

model WarehouseStock {
  id          String    @id @default(uuid())
  productId   String
  warehouseId String
  quantity    Float     @default(0)
  product     Product   @relation(fields: [productId], references: [id])
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([productId, warehouseId])
}

model POSStock {
  id          String      @id @default(uuid())
  productId   String
  posId       String
  quantity    Float       @default(0)
  product     Product     @relation(fields: [productId], references: [id])
  pointOfSale PointOfSale @relation(fields: [posId], references: [id])

  @@unique([productId, posId])
}

model StockMovement {
  id             String       @id @default(uuid())
  productId      String
  type           MovementType
  fromLocationId String? // Warehouse ID or POS ID depending on type
  toLocationId   String? // Warehouse ID or POS ID depending on type
  quantity       Float
  costAtMoment   Float
  rateAtMoment   Float        @default(1)
  createdAt      DateTime     @default(now())
  product        Product      @relation(fields: [productId], references: [id])
}

model CurrencyRate {
  id         String   @id @default(uuid())
  currencyId String
  rate       Float
  date       DateTime @default(now())
  createdAt  DateTime @default(now())
  currency   Currency @relation(fields: [currencyId], references: [id])
}

model Customer {
  id         String    @id @default(uuid())
  businessId String
  name       String
  phone      String?
  email      String?
  business   Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  debts      Debt[]
  deletedAt  DateTime?
  createdAt  DateTime  @default(now())
}

model Debt {
  id           String        @id @default(uuid())
  customerId   String
  amount       Float
  currencyId   String
  rateAtMoment Float
  saleId       String?       @unique
  customer     Customer      @relation(fields: [customerId], references: [id])
  currency     Currency      @relation(fields: [currencyId], references: [id])
  sale         Sale?         @relation(fields: [saleId], references: [id])
  payments     DebtPayment[]
  deletedAt    DateTime?
  createdAt    DateTime      @default(now())
}

model DebtPayment {
  id           String   @id @default(uuid())
  debtId       String
  amount       Float
  currencyId   String
  rateAtMoment Float
  createdAt    DateTime @default(now())
  debt         Debt     @relation(fields: [debtId], references: [id])
  currency     Currency @relation(fields: [currencyId], references: [id])
}

model Sale {
  id           String      @id @default(uuid())
  posId        String
  totalCUP     Float       @default(0)
  totalUSD     Float       @default(0)
  totalMLC     Float       @default(0)
  rateAtMoment Float
  pointOfSale  PointOfSale @relation(fields: [posId], references: [id])
  items        SaleItem[]
  debt         Debt?
  deletedAt    DateTime?
  createdAt    DateTime    @default(now())
}

model SaleItem {
  id           String  @id @default(uuid())
  saleId       String
  productId    String
  quantity     Float
  price        Float
  costAtMoment Float
  sale         Sale    @relation(fields: [saleId], references: [id])
  product      Product @relation(fields: [productId], references: [id])
}

model Expense {
  id            String    @id @default(uuid())
  businessId    String
  description   String
  amount        Float
  currencyId    String
  category      String
  isOnatPayment Boolean   @default(false)
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  currency      Currency  @relation(fields: [currencyId], references: [id])
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())
}
